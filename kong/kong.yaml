_format_version: "3.0"

services:
  # Product Catalog Servic
  - name: product-service
    protocol: grpc
    host: product-catalog-service
    port: 8080
    plugins:
      - name: grpc-gateway
        config:
          proto: /kong/proto/product/v1/product.proto

  # User Service
  - name: user-service
    protocol: grpc
    host: user-service
    port: 8080
    plugins:
      - name: grpc-gateway
        config:
          proto: /kong/proto/user/v1/user.proto

  # Shopping Cart Service
  - name: cart-service
    protocol: grpc
    host: shopping-cart-service
    port: 8080
    plugins:
      - name: grpc-gateway
        config:
          proto: /kong/proto/cart/v1/cart.proto
      - name: cors
        config:
          origins:
            - http://localhost:8089
          methods:
            - GET
            - POST
            - DELETE
            - PATCH
            - OPTIONS
          headers:
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600

  # Order Service
  - name: order-service
    protocol: grpc
    host: order-service
    port: 8080
    plugins:
      - name: grpc-gateway
        config:
          proto: /kong/proto/order/v1/order.proto

  # Payment Service
  - name: payment-service
    protocol: grpc
    host: payment-service
    port: 8080
    plugins:
      - name: grpc-gateway
        config:
          proto: /kong/proto/payment/v1/payment.proto

routes:
  # Product Catalog Routes
  - name: products-list
    paths: [/api/v1/products]
    methods: [GET, POST]
    service:
      name: product-service
    strip_path: true

  - name: products-detail
    paths: ["~/api/v1/products/[a-zA-Z0-9-_]+$"]
    methods: [GET, PATCH, DELETE]
    service:
      name: product-service
    strip_path: true

  # User Service Routes
  - name: user-register
    paths: [/api/v1/auth/register]
    methods: [POST]
    service:
      name: user-service
    strip_path: true

  - name: user-login
    paths: [/api/v1/auth/login]
    methods: [POST, OPTIONS]
    service:
      name: user-service
    strip_path: true
    plugins:
        - name: cors
          config:
            origins:
              - http://localhost:8089
            methods:
              - POST
              - OPTIONS
            headers:
              - Content-Type
              - Authorization
            credentials: true
            max_age: 3600

  - name: user-profile
    paths: [/api/v1/users/profile]
    methods: [GET, PUT]
    service:
      name: user-service
    strip_path: true
    plugins:
      - name: jwt

  # Shopping Cart Routes
  - name: cart-view
    paths: [/api/v1/cart]
    methods: [GET, DELETE, OPTIONS]
    service:
      name: cart-service
    strip_path: true
    plugins:
      - name: jwt

  - name: cart-add
    paths: [/api/v1/cart/items]
    methods: [POST, OPTIONS]
    service:
      name: cart-service
    strip_path: true
    plugins:
        - name: jwt

  - name: cart-update
    paths: [~/api/v1/cart/items/\d+$]
    methods: [PATCH, DELETE]
    service:
      name: cart-service
    strip_path: true
    plugins:
        - name: jwt

  # Order Service Routes
  - name: orders
    paths: [/api/v1/orders]
    methods: [GET, POST, OPTIONS]
    service:
      name: order-service
    strip_path: true
    plugins:
      - name: jwt
      - name: cors
        config:
          origins:
            - http://localhost:8089
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600

  - name: order-detail
    paths: [~/api/v1/orders/\d+$]
    methods: [GET]
    service:
      name: order-service
    strip_path: true
    plugins:
      - name: jwt

  # Payment Service Routes
  - name: payments
    paths: [/api/v1/payments/initiate]
    methods: [POST, OPTIONS]
    service:
      name: payment-service
    strip_path: true
    plugins:
      - name: jwt
      - name: cors
        config:
          origins:
            - http://localhost:8089
          methods:
            - GET
            - POST
            - OPTIONS
          headers:
            - Content-Type
            - Authorization
          credentials: true
          max_age: 3600

  - name: get-payments
    paths: [/api/v1/payments]
    methods: [GET]
    service:
      name: payment-service
    strip_path: true
    plugins:
      - name: jwt

plugins:
  - name: rate-limiting
    config:
      minute: 100
      policy: local

consumers:
  - username: my-api-user
    jwt_secrets:
      - algorithm: HS256
        key: my-unique-issuer-key
        secret: my-secret-key