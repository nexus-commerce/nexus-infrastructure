apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  namespace: api
data:
  kong.yaml: |
    _format_version: "3.0"

    services:
      # Product Catalog Service
      - name: product-service
        protocol: grpc
        host: product-catalog-service.services.svc.cluster.local
        port: 8080
        plugins:
          - name: grpc-gateway
            config:
              proto: /kong/proto/product/v1/product.proto

      # User Service
      - name: user-service
        protocol: grpc
        host: user-service.services.svc.cluster.local
        port: 8080
        plugins:
          - name: grpc-gateway
            config:
              proto: /kong/proto/user/v1/user.proto

      # Shopping Cart Service
      - name: cart-service
        protocol: grpc
        host: shopping-cart-service.services.svc.cluster.local
        port: 8080
        plugins:
          - name: grpc-gateway
            config:
              proto: /kong/proto/cart/v1/cart.proto

      # Order Service
      - name: order-service
        protocol: grpc
        host: order-service.services.svc.cluster.local
        port: 8080
        plugins:
          - name: grpc-gateway
            config:
              proto: /kong/proto/order/v1/order.proto

      # Payment Service
      - name: payment-service
        protocol: grpc
        host: payment-service.services.svc.cluster.local
        port: 8080
        plugins:
          - name: grpc-gateway
            config:
              proto: /kong/proto/payment/v1/payment.proto

    routes:
      # Product Catalog Routes
      - name: products-list
        paths: [/api/v1/products]
        methods: [GET, OPTIONS]
        service: product-service
        strip_path: true

      - name: products-create
        paths: [ /api/v1/products ]
        methods: [POST, OPTIONS]
        service: product-service
        strip_path: true
        plugins:
          - name: jwt

      - name: products-detail
        paths: ["~/api/v1/products/[a-zA-Z0-9-_]+$"]
        methods: [GET, OPTIONS]
        service: product-service
        strip_path: true

      - name: products-edit
        paths: ["~/api/v1/products/[a-zA-Z0-9-_]+$"]
        methods: [PATCH, DELETE, OPTIONS]
        service: product-service
        strip_path: true
        plugins:
          - name: jwt

      # User Service Routes
      - name: user-register
        paths: [/api/v1/auth/register]
        methods: [POST, OPTIONS]
        service: user-service
        strip_path: true

      - name: user-login
        paths: [/api/v1/auth/login]
        methods: [POST, OPTIONS]
        service: user-service
        strip_path: true

      - name: user-profile
        paths: [/api/v1/users/profile]
        methods: [GET, PATCH, OPTIONS]
        service: user-service
        strip_path: true
        plugins:
          - name: jwt

      # Shopping Cart Routes
      - name: cart-view
        paths: [/api/v1/cart]
        methods: [GET, DELETE, OPTIONS]
        service: cart-service
        strip_path: true
        plugins:
          - name: jwt

      - name: cart-add
        paths: [/api/v1/cart/items]
        methods: [POST, OPTIONS]
        service: cart-service
        strip_path: true
        plugins:
            - name: jwt

      - name: cart-update
        paths: ["~/api/v1/cart/items/[a-zA-Z0-9-_]+$"]
        methods: [PATCH, DELETE, OPTIONS]
        service: cart-service
        strip_path: true
        plugins:
            - name: jwt

      # Order Service Routes
      - name: orders
        paths: [/api/v1/orders]
        methods: [GET, POST, OPTIONS]
        service: order-service
        strip_path: true
        plugins:
          - name: jwt

      - name: order-detail
        paths: [~/api/v1/orders/\d+$]
        methods: [GET, OPTIONS]
        service: order-service
        strip_path: true
        plugins:
          - name: jwt

      # Payment Service Routes
      - name: payments
        paths: [/api/v1/payments]
        methods: [GET, POST, OPTIONS]
        service: payment-service
        strip_path: true
        plugins:
          - name: jwt

    plugins:
      - name: rate-limiting
        config:
          minute: 100
          policy: local
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Content-Type
            - Authorization
          exposed_headers:
            - Authorization
          credentials: true
          max_age: 3600

    consumers:
      - username: my-api-user
        jwt_secrets:
          - algorithm: HS256
            key: my-unique-issuer-key
            secret: my-secret-key